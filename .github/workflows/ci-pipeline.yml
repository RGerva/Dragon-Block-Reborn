name: Java CI Pipeline

on: [push, pull_request, workflow_dispatch]

jobs:

  validation:
    name: ✅ Gradle Wrapper Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gradle/actions/wrapper-validation@v4

  dependency-submission:
    name: 📦 Dependency Graph
    runs-on: ubuntu-latest
    needs: validation
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
      - uses: gradle/actions/dependency-submission@v4

  spotless-check:
    name: ✨ Spotless Check
    runs-on: ubuntu-latest
    needs: validation
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v4
      - run: chmod +x gradlew
#      - run: ./gradlew spotlessCheck --no-daemon

  build-and-test:
    name: 🧪 Build & Test with Coverage
    runs-on: ubuntu-latest
    needs: [validation, spotless-check]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v4
      - run: chmod +x gradlew
      - run: ./gradlew build jacocoTestReport --no-daemon
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/reports/jacoco/test/jacocoTestReport.xml
          flags: unittests
          name: codecov-report

  generate-data:
    name: 📄 Generate Data
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v4
      - run: ./gradlew runData --no-daemon

  analyze:
    name: 🔍 CodeQL Analyze
    runs-on: ubuntu-latest
    needs: [validation, spotless-check]
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin
          build-mode: manual
      - run: chmod +x gradlew
      - run: ./gradlew build --no-daemon
      - uses: github/codeql-action/analyze@v3
